# vacine
Bom, para começo de conversa o contexto que nos lembramos é o seguinte: 
- Aplicação (app/dashboard) foram desenvolvidos utilizando flutter-flow 
- Firebase para o backend & actions 
- Backend começou a ser migrado para o Supabase (algumas tabelas já foram criadas)
- Decidiram migrar todo o aplicativo para um novo projeto (nova conta do flutter-flow), trazendo as telas e modificando as Actions

O que me pediram para fazer primeiramente (Tarefas) ? 
- Migrar fluxo de cadastro de novo enfermeiro (frontend/backend)

O que eu realmente gostaria de fazer ? 
- Definir uma organização de telas [100]
- Definir uma organização de componentes (entender como seria possível isso) [20]
- [ ] Compreender como a estrutura do projeto funciona (telas, actions, statemanagement, versionamento e deploy) tanto no flutter-flow quanto no supabase [200 required] 

**Working on (don't judge here..!)**
1. Compreender como a estrutura do projeto funciona (telas, actions, statemanagement, versionamento e deploy) tanto no flutter-flow quanto no supabase 

**Acessos**
- [Notion Vaccini](https://www.notion.so/flowcodecc/Vaccini)
- [Supabase Vaccini](https://supabase.com/dashboard/projects))

Babysteps [start here]
<- 1 -> (50m <)
- [x] Explorar o notion 
- [x] Observar diagrama do banco 
- [x] Testar aplicação e mapear funcionalidades
<- 2 -> 
- [x] Explorar funcionalidades do flutter-flow (1h >)
  - Gerenciamento de estados (app, página e componente)
  - Gerenciamento dos componentes 
  - Versionamento 
  [tip] Tente não se ater demais a como as coisas *deveriam* se feitas e refatore  o mínimo para tornar o que está hoje adequado. 
- [x] Explorar funcionalidades do Supabase (1h >)
  - Instalação e desenvolvimento local 
  - Tabelas & Migrations 
  - CRUD Automatizado
  - Edge functions
  - Outras cossistas interessantes..
- [x] Escrever tarefas 

**Compilando informações e compreensão**


07/11/24
**<- O começo da minha nova jornada de trabalho ->** 

**O que já funcionou em nossas vidas ? (E aprendemos certo)**
- Comprometimento -> todas as vezes em que nos dedicamos a "sofrer" certamente fomos bem recompensados. Está recompensa pelo que aprendemos nestes últimos meses não é financeira, mas se dá o financeiro a partir da evolução e da profissionalização dos assuntos (vide instalação dos pisos, programação e ferramentaria)
- Disciplina -> Estar todos os dias nos horários certos, repetindo os mesmos comportamentos e estando aberto ao que der e vier. Respirar nem sempre é sobre respirar direito, é sobre *tender* a respirar corretamente. 
- Silêncio (e o silêncio pro-ativo) -> Quando não se sabe, não se manifesta. Quando se sabe pouco, se manifesta pouco - Isso se traduz em uma melhor qualidade de percepção na mesma medida em que a mente se aquieta.  

**O que nunca funcionou ? (E aprendemos errado)**

- Jeitinho brasileiro (e outras vias de atalho que não nos levam a lugar algum)
Certamente buscar atalhos está em nossa natureza, assim como procrastinar, hiper-estimulação e outros bug's causados por nossa **natureza** também - portanto **tudo é sempre uma faca de dois legumes**. "No caminho do excesso seja menos, No caminho da falta seja mais." - Fazendo sempre mais é possível com clareza saber quando se **poderia** fazer um pouco menos. 
- O limite do errado (e os caminhos tortos que tomamos por preguiça/medo dentre outras desculpas)
Acho que não precisamos nem nos estender, apenas nos lembrarmos da quantidade de vezes que estressamos a linha do **bom-senso** e **"ingênuidade"** das pessoas e o quanto isso nos beneficiou denegrindo nossa postura e nos tornando alguém de pouca confiança. 
- O falar sem o fazer 
- O pensar sem o realizar 
- A complexidade sem a necessidade
- A simplicidade pela falta de ânimo 
- A desordem pela simples falta de limpeza e organização 
- A falta de obediência em relação ao Ser e as suas Verdadeiras tarefas 

**Aonde devemos chegar ?**

Creio eu que tenhamos compilado alguns pontos bastante importantes para nós, que repetimos muito nesses últimos anos tentando ser "profissionais". 
- Ao buscar firmeza e maturidade se lembre do seu Caboclo 
- Ao buscar abertura, movimento e realização se lembre do seu Exu 
- Ao buscar simplicidade, força e determinação se lembre dos seus Pretos e Pretas velhas 
- Ao buscar vencer se lembre de Ogum
- Ao buscar amar se lembre de Iemanjá 
- Ao buscar se lembrar de si, lembre-se de Oxum 
- Ao expandir sua mente, se lembre de Oxóssi
- E quando nenhuma dessas figuras vier a mente, quando a escuridão estiver predominante se lembre do Senhor JESUS CRISTO DE NAZARÉ. 
Em silêncio encontre a si, em silêncio permaneça em si e desfrutará da razão do não falar. 

**Quais são os nossos primeiros objetivos**
- Implementar uma boa rotina de trabalho que envolva seriedade
- Acostumar-se novamente & desenvolver novamente um **momentum** para voltar a ativa
- O simples é o eficiente e inteligente - Sempre



Bom dia, hoje temos muitas coisas a enfrentar, elas são

**End of day**
Meu irmão, muito obrigado por hoje, vc foi ponta firme e se mostrou o que eu precisava ver. Obviamente ainda temos muito a refinar mas hoje nos comprometemos a estudar isso daqui e fomos capazes, portando muito obrigado. 
Eu só tenho a agradecer a Você senhor que cuida de mim, da minha mente e tem me ajudado tanto a ser autodidata, mas que eu nunca me esqueça do quão difícil as coisas são e prometo que os segredos deixarei bem guardados. 

Meu muito obrigado meu senhor 

**Tarefas do dia**
- [x] Pagamento CNH envio pelo correios
- [ ] Conclusão das tarefas do Kanbam Vaccini 
- [x] Corrigir e-mail @bol e criar novo email @gmail para a pargon & Notificar os contatos para enviarem no novo email
- [x] Jantar com a Sanã em algum lugar bacana (Bacana não rolou.. rs)

---

working_days: 
- 08-11-24
- 11-11-24

**Working today**
- [ ] [20%] Migração aplicação Vaccini 
**Contextualização**  
  - [ ] Leitura da documentação Notion 
  - [ ] Leitura do diagrama de banco 
  - [ ] [only necessary] Mapeamento de todas as funcionalidades-telas 
**Setup do projeto** [80%]
  - [x] Instalar e executar *flutter-flow* localmente
  - [x] [current] Instalar e executar *supabase* localmente 
    - Conectar com o projeto `yhvzhmzlmfkyabsmmtvg` já existente
    - [x] dump database
    - [x] connect prod-db
    - [x] connect local-db
    - [x] re-dump db
    - [x] run cli
    - [x] compreender mecânismo de registro/autenticação 
      - [x] Verificar como é possível realizar autenticação utilizando email/senha
      - [tip] - A RESTApi em Produção solicita uma APIKey + AuthKey 
      - [x] Tentar resgatar informações de uma tabela utilizando auth_key
      - [x] Verificar se é mais adequado adicionar informações dentro da table auth.users ou vincular o registro de um novo usuário 
      - [tip] O mais adequado é adicionar uma nova tabela relacionada diretamente com auth chamada profiles - e iniciar uma trigger para registrar um profile quando um usuário realizar signup 
      - [here_now]
      
[current]
- [x] Modificar a tabela de *users* adicionando uma nova tabela *address* e com trigger na criação de um novo usuário supabase.   
  - [x] 1. Adicionar tabela addresses
  - [x] 2. Corrigir tabela profiles
  - [x] 3. Adicionar tabela app_roles
  - É necessário adicionar um novo usuário supabase utilizando um contexto para que o profile seja registrado corretamente. 
[here]
- [x] Adicionar e testar trigger para adição de Profile no registro de um novo usuário. 
```sql
<- Creating table -> 
CREATE TABLE public.profiles_test ( id uuid NOT NULL DEFAULT gen_random_uuid(), id_user uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE, id_role uuid REFERENCES public.app_roles(id), -- Foreign key to app_roles first_name text, last_name text, email text, gender text, phone text, img_url text, created_at timestamp with time zone DEFAULT now(), deleted_at timestamp with time zone, -- Can be set to NULL by default PRIMARY KEY (id) );

create function public.handle_new_user()
returns trigger 
language plpgsql
security definer set search_path = public
as $$ 
begin 
  insert into public.profiles (id_user, id_role, first_name, last_name, email, gender, phone, img_url)
  values (
  new.id,
  (select id from public.roles where role_name = 'manager'), 
  new.raw_user_meta_data ->> 'first_name', 
  new.raw_user_meta_data ->> 'last_name',
  new.raw_user_meta_data ->> 'email',
  new.raw_user_meta_data ->> 'gender',
  new.raw_user_meta_data ->> 'phone',
  new.raw_user_meta_data ->> 'img_url'
  ); 
  return new; 
end; 
$$; 

create trigger on_auth_user_created  
  after insert on auth.users  
  for each row execute procedure public.handle_new_user();
```

- [x] Conferir se o profile está sendo gerado automaticamente (incluindo os atributos opcionais necessários)


    
  **Implementação**
  - [ ] 1. Migrar módulo *Criação de Perfil*
    - [ ] Mover telas já registradas na aplicação App para Migrating 
    - [ ] Verificar se as tabelas de usuário já existem
    - [ ] Verificar se as validações acontecem apenas no on-submit
    - [ ] Adicionar action do supabase no on-submit do formulário 
    [?] - Verificar como funcionará o sistema de Login para as tabelas de User, e se com a tabela modificada funcionará corretamente

**Comandos para gerar esse sync auth.users - public.profiles**
```SQL
-- 1 Add table `app_roles` -- 
CREATE TABLE public.app_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(), 
  role_name text NOT NULL, 
  created_at timestamp with time zone NOT NULL DEFAULT now() 
);

-- 1.2. Insert the `manager` role 
INSERT INTO public.app_roles(id, role_name)
VALUES (gen_random_uuid(), 'manager');

-- 2. Add table public.profiles -- 
CREATE TABLE public.profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  id_user uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  id_role uuid NOT NULL REFERENCES public.app_roles(id),
  first_name text,
  last_name text,
  email text,
  gender text,
  phone text,
  img_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  deleted_at timestamp with time zone,
  
  PRIMARY KEY (id)
);

-- 2.1 Add the function & trigger to sync profiles on signUp -- 
CREATE FUNCTION public.handle_signup()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (
    id,
    id_user,
    id_role,
    first_name,
    last_name,
    email,
    gender,
    phone,
    img_url
  )
  VALUES (
    gen_random_uuid(),
    NEW.id,
    (SELECT id FROM public.app_roles WHERE role_name = 'manager'),
    NEW.raw_user_meta_data ->> 'first_name',
    NEW.raw_user_meta_data ->> 'last_name',
    NEW.raw_user_meta_data ->> 'email',
    NEW.raw_user_meta_data ->> 'gender',
    NEW.raw_user_meta_data ->> 'phone',
    NEW.raw_user_meta_data ->> 'img_url'
  );

  RETURN NEW;
END;
$$;

CREATE TRIGGER on_auth_user_created  
AFTER INSERT ON auth.users  
FOR EACH ROW EXECUTE FUNCTION public.handle_signup();

-- 3. Add table `addresses` 
CREATE TABLE public.addresses (
  id uuid NOT NULL DEFAULT gen_random_uuid(), 
  id_profile uuid NOT NULL REFERENCES public.profiles(id),
  street text NOT NULL,
  number text NOT NULL, 
  complement text, 
  neighborhood text NOT NULL, 
  city text NOT NULL, 
  state text NOT NULL, 
  created_at timestamp with time zone NOT NULL DEFAULT now(),

  PRIMARY KEY(id)
);
```

--- 
**Notebook**

**Connections**
```json
db_connection: "postgresql://postgres.yhvzhmzlmfkyabsmmtvg:ul2boczhWLDgqSfO@aws-0-sa-east-1.pooler.supabase.com:6543/postgres"
connection: {
  host: "aws-0-sa-east-1.pooler.supabase.com"
  port: 6543
  user: postgres.yhvzhmzlmfkyabsmmtvg
  pass: ul2boczhWLDgqSfO
}

```

**Supabase**
```json
local_enviroment: 
  app_cli: "http://localhost:54323"
  api_gateway: "http://localhost:54321"
  pg_connection: "postgresql://postgres:postgres@localhost:54322/postgres"
  [tip]: When calling pg from `edge functions` use the host `host.docker.internal`
  [tip]: If you do not want to expose your table simple add to other schema than `public`
  anon_api_key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
  bearer_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"

commands:
  - supabase projects list 
  - supabase link --project-id {id}
  running:
    - supabase start 
    - supabase stop 
  db: 
    diff        Diffs the local database for schema changes
    dump        Dumps data or schemas from the remote database
    lint        Checks local database for typing error
    pull        Pull schema from the remote database
    push        Push new migrations to the remote database
    reset       Resets the local database to current migrations
    start       Starts local Postgres database


[tip] - All @auth endpoinasdasdts are placed on 
https://github.com/supabase/auth#endpoints

@auth-routes
/auth/v1/token?grant_type=password
{ email: string, password: string } - give us a token of a authdb.user 
```

**Supabase Policies**
```json
@example-policy
create policy "example"
on "public.{table_name}"
as PERMISSIVE | RESTRICTIVE (OR ou AND para + policies)
for SELECT | INSERT | UPDATE | DELETE | ALL 
using ? ( // On select ops
    id_user = auth.uid()
)
with-check ? ( // On insert ops 
  id_user = auth.uid() AND
  email IS NOT NULL
)

@read-own
create policy "read-own"
on "public.test_table"
as PERMISSIVE
for SELECT
using (
  id_user = auth.uid();
)
```

**PSQL**
```json
- \l list all dbs
- \c {db} select the db
- \dt list all tables
```

**SQL**
```json
1. Query how many rows are inside every table of a database
SELECT 
  table_name,
  (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name = t.table_name) AS row_count 
  FROM information_schema.tables t WHERE table_schema = 'public' AND table_type = 'BASE TABLE';
```


--- 
#### Ajudando a Sanã - Conseguimoss, e conseguimos consertar!
**Situação UTM_SOURCE Sanã**

Relato:
-  Ao entrar em uma campanha 
https://www.autocompara.com.br/promocao-seguro-auto-de-milhoes?CUPOM=SEGURODEMILHOES&utm_source=prospecting-cybba&utm_medium=social&utm_campaign=segurodemilhoes
-  Quando clico no botão *Contrate Aqui* sou redirecionado para
https://www.autocompara.com.br/cotacao/sobre-voce?CUPOM=SEGURODEMILHOES&utm_source=landing-page1&utm_medium=banner&utm_campaign=SAM
- Quando clico no botão *Simular Cotação* sou redirecionado para
https://www.autocompara.com.br/cotacao/sobre-voce?CUPOM=SEGURODEMILHOES&utm_source=landing-page2&utm_medium=banner&utm_campaign=SAM

**Perguntas**
- Algum parâmetro se mantém quando eu adiciono manualmente ? 
R: Não, todos os parâmetros são substituídos
Portanto => Muito provavelmente a URL está sendo substituída completamente pelo redirect aplicado no front-end. Isso não só ocasiona a perca do *utm_source* neste caso da Cybba, como em outras páginas do site. 

Implicações: 
1. O analytics provavelmente está contabilizando duas aquisições de sessão, ou está contabilizando eventos/aquisições erradas. 
Razão:
- Ao acessar a URL https://www.autocompara.com.br/?utm_source=email e navegar entre qualquer um dos link's disponíveis o *utm_source* é perdido, o que gera duas *Aquisições de Sessão*, uma do utm_source *enviado inicialmente* e outra *orgânica* porquê a original foi perdida. 
2. O analytics não está *relacionando* os eventos da página ao utm_source (A pessoa clicou em um botão através da Cybba ou Orgânico ?)
3. Ao atribuir diretamente os parâmetros na URL de um redirect estamos *forçando* com que um utm_source seja atribuído portanto ***perdemos*** as métricas coerentes

Explicação provável:
1. Os redirect's feitos pelo front-end não estão registrando a utm_source inicial e repassando para as páginas seguintes.
2. Os utm_sources estão sendo definidos manualmente nas url's de redirecionamento como o ***botão do banner*** por exemplo. 

Possível solução (resolução no front-end): 
1. É necessário implementar um mecânismo que conserve o parâmetro utm_source e outros parâmetros de URL e repasse para a URL dos próximos redirecionamentos. 
2. Verificar todos os redirecionamentos que estão abrindo uma nova aba, o que (@todo) faz com que a sessão inicial (mesmo que tenha o mesmo utm_source) seja perdida e outra seja registrada no lugar. 
Recursos: 
[#GTMTips: Fix The Rogue Referral Problem In Single-Page Sites | Simo Ahava's blog](https://www.simoahava.com/gtm-tips/fix-rogue-referral-problem-single-page-sites/)